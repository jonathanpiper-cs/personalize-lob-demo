<script lang="ts">
	// export const csr = 'true';
	import { onMount } from 'svelte';
	import type { IGenre } from '$lib/types';
	// let { data } = $props();
	// const entry: IGenre | null = data ? data.entry : null;
	// import Personalize from '@contentstack/personalize-edge-sdk';

	// const setAttribute = async (attribute: string, value: string) => {
	// 	console.log('set attribute', attribute, value);
	// 	const attrString = JSON.parse(`{ "${attribute}": "${value}" }`);
	// 	await Personalize.set(attrString);
	// };
	import ContentstackLivePreview from '@contentstack/live-preview-utils';
	import { page } from '$app/stores';
    console.log($page.url.searchParams)
	// let hash;
	// if (window) {
	// 	hash = ContentstackLivePreview.hash;
	// }
	const hash = $page.url.searchParams.get('live_preview');
	const CS_API_KEY = 'blt9462c452422a2d8e';
	const CS_DELIVERY_TOKEN = 'cs1f096eb927ef858b5e14d104';
	const CS_PREVIEW_TOKEN = 'cs534c818b03c981fbc68ecc40';
	const host = 'graphql.contentstack.com';
	const previewHost = 'graphql-preview.contentstack.com';
	const graphqlUrl = new URL(`https://${host}/stacks/${CS_API_KEY}?environment=prod`);
	const query = `
        query MyQuery {
            all_genre(where: {url: "/genre/heavy-metal"}) {
                items{
                    title
                    summary
                    description {
                    json
                    }
                }
            }
        }
    `;
	const headers = new Headers();
	headers.append('access_token', CS_DELIVERY_TOKEN);
	headers.append('api_key', CS_API_KEY);
	headers.append('Content-Type', 'application/json');
	if (hash) {
		headers.append('live_preview', hash);
		headers.append('preview_token', CS_PREVIEW_TOKEN);
		graphqlUrl.host = previewHost;
	}
	let entry: IGenre = $state({ title: '', summary: '', description: '', uid: '', url: '' });
	onMount(async () => {
		const data = await fetch(graphqlUrl.toString(), {
			method: 'POST',
			body: JSON.stringify({ query: query }),
			headers: headers,
            mode: 'cors'
		});
		const entries = await data.json();
		entry = { ...entries.data.all_genre.items[0] };
		console.log($state.snapshot(entry));
	});
	$effect(() => {
		console.log($state.snapshot(entry));
	});
</script>

{#await entry}
	<h1 data-cslp={entry.$.title}>{entry.title}</h1>
	<p data-cslp={entry.$.summary}>{entry.summary}</p>
	<p data-cslp={entry.$.description}>{@html entry.description}</p>
{/await}

<!-- <a class="anchor" onclick={() => setAttribute('favorite_genre', 'metal')}>I like metal</a> -->
